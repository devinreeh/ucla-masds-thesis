---
title: "MASThesis"
author: "Devin Reeh"
date: "2025-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
# I. Running Variable and Cut off
What:
Use school-level FRPM eligibility % as the running variable. Define one or more cutoffs (e.g., 75%, 85%, 90%) where eligibility for food or afterschool programs changes.

Why it's important:
RDD depends on a predictable rule where treatment assignment discontinuously changes at a threshold. This makes it possible to estimate causal effects near the cutoff.

How it supports your thesis:
These cutoffs create a natural experiment. Schools just above and just below the FRPM threshold are comparable, allowing you to isolate the effect of the program (food or BTB) from confounding factors.

# Identify Treatement Assignment and Outcome Variables
What:

For treatment: Identify if a school participates in the food program (CEP) or the afterschool BTB program in a given year.

For outcomes: Use metrics like attendance rate, standardized test scores, or graduation rates.

Why it's important:
You need clear and measurable definitions of both the intervention (treatment) and the outcomes it is supposed to influence.

How it supports your thesis:
Establishes a cause-and-effect structure — you're asking: “Do schools just above the FRPM threshold, who get the program, show better outcomes than those just below?”



# Estimate the Treatment Effect with Local Linear Regression
What:
Use local linear regression (with a small bandwidth around the cutoff) to estimate the treatment effect at the threshold.

Why it's important:
This is the core of RDD — using only schools close to the cutoff, fit a regression model that separately estimates trends from either side and captures the jump at the cutoff.

How it supports your thesis:
This gives you the local average treatment effect (LATE) — the causal effect of the program on schools near the threshold. This is your key result.

# Estimate the Treatment Effect with Local Linear Regression
What:
Use local linear regression (with a small bandwidth around the cutoff) to estimate the treatment effect at the threshold.

Why it's important:
This is the core of RDD — using only schools close to the cutoff, fit a regression model that separately estimates trends from either side and captures the jump at the cutoff.

How it supports your thesis:
This gives you the local average treatment effect (LATE) — the causal effect of the program on schools near the threshold. This is your key result.

# Choose and Justify Bandwidth
What:
Use data-driven methods (e.g., Imbens-Kalyanaraman or Calonico-Cattaneo-Titiunik (CCT)) to select optimal bandwidths.

Why it's important:
Bandwidth determines how many schools around the cutoff are included in the regression. Too wide = biased; too narrow = noisy.

How it supports your thesis:
Justifying bandwidths ensures credible identification and protects against cherry-picking results. It gives your estimates scientific rigor.


# Interpret and Contextualize the Results
What:
Quantify the effect size (e.g., “BTB increases attendance by 1.5% for schools near 75% FRPM cutoff”) and discuss policy implications.

Why it's important:
You’re connecting statistical results to real-world meaning — which is the goal of your thesis.

How it supports your thesis:
You can now confidently argue that FRPM-based eligibility cutoffs caused changes in outcomes — backing your case that these programs have measurable benefits (or not).

```{r, echo=FALSE}
# ──────────────────────────────────────────────────────────────
# 0.  Load packages
# ──────────────────────────────────────────────────────────────
# install.packages(c("readxl", "dplyr"))
library(readxl)
library(dplyr)
library(stringr)


# ──────────────────────────────────────────────────────────────
# 1.  FRPM 2021-22  →  frpm_lausd (clean names)
# ──────────────────────────────────────────────────────────────
frpm_path <- "~/Downloads/frpm2122_v2.xlsx"

# If the FRPM sheet name is uncertain, take the 2nd sheet (adjust if needed)
frpm_raw <- read_excel(frpm_path, sheet = 2, skip = 1)

# Explicit column rename vector  (index order must match colnames(frpm_raw))
names(frpm_raw) <- c(
  "academic_year",
  "county_code",
  "district_code",
  "school_code",
  "county_name",
  "district_name",
  "school_name",
  "district_type",
  "school_type",
  "educational_option_type",
  "nslp_provision_status",
  "charter_school_yn",
  "charter_school_number",
  "charter_funding_type",
  "irc",
  "low_grade",
  "high_grade",
  "enrollment_k_12",
  "free_meal_count_k_12",
  "percent_eligible_free_k_12",
  "frpm_count_k_12",
  "percent_eligible_frpm_k_12",
  "enrollment_5_17",
  "free_meal_count_5_17",
  "percent_eligible_free_5_17",
  "frpm_count_5_17",
  "frpm_rate",                      # running variable
  "calpads_cert_status"
)

frpm_lausd <- frpm_raw %>%
  filter(district_name == "Los Angeles Unified") %>%
  select(school_name, school_code, frpm_rate) %>%
  mutate(
    school_name = toupper(trimws(school_name)),
    frpm_rate   = as.numeric(frpm_rate),
    schoolcode = as.character(school_code)
  )

# ──────────────────────────────────────────────────────────────
# 2.  Chronic Absenteeism TXT  →  attendance_lausd
# ──────────────────────────────────────────────────────────────
att_path <- "~/Downloads/chronicabsenteeism22-v3.txt"

att_raw <- read.delim(att_path, sep = "\t", quote = "\"", stringsAsFactors = FALSE)

# Minimal rename for needed columns
names(att_raw)[ names(att_raw) == "District.Name"            ] <- "district_name"
names(att_raw)[ names(att_raw) == "School.Name"              ] <- "school_name"
names(att_raw)[ names(att_raw) == "School.Code"              ] <- "school_code"
names(att_raw)[ names(att_raw) == "ChronicAbsenteeismRate"   ] <- "chronic_absenteeism"


attendance_lausd <- att_raw %>%
  filter(district_name == "Los Angeles Unified") %>%
  mutate(
    school_code = as.character(school_code),
    chronic_absenteeism  = as.numeric(na_if(chronic_absenteeism, '*')),
    ChronicAbsenteeismEligibleCumulativeEnrollment = as.numeric(na_if(ChronicAbsenteeismEligibleCumulativeEnrollment, '*')),
    ChronicAbsenteeismCount = as.numeric(na_if(ChronicAbsenteeismCount, '*')),
  )

# ──────────────────────────────────────────────────────────────
# 3.  Merge  +  create RDD vars
# ──────────────────────────────────────────────────────────────
merged <- inner_join(frpm_lausd, attendance_lausd, by = "school_code") %>%
  mutate(
    treated = ifelse(frpm_rate >= 0.75, 1, 0),
    running = frpm_rate - 0.75
  )

# ──────────────────────────────────────────────────────────────
# 4.  Beyond-the-Bell  →  add btb_participation
# ──────────────────────────────────────────────────────────────
btb_path <- "~/Downloads/BeyondTheBellSchoolSitePrograms-20212022 copy.csv"
btb_raw  <- read.csv(btb_path, stringsAsFactors = FALSE)

# Rename the single column we need
names(btb_raw)[ names(btb_raw) == "School" ] <- "school_name"


btb_clean <- btb_raw %>%
  mutate(
    btb_am = ifelse(is.na(BeforeSchoolGrantProgram), 0, 1),
    btb_pm = ifelse(is.na(AfterSchoolGeneralFundedPrograms) | is.na(AfterSchoolGrantProgram), 0, 1),
    CDSCode = as.character(CDSCode),
    school_code = str_sub(CDSCode, -7)
  )

# btb_clean %>%
#   count(school_code) %>%
#   filter(n > 1)

btb_unique <- btb_clean %>%
  group_by(school_code) %>%
  summarise(
    SchoolYear = first(SchoolYear),  # or customize how you want to handle it
    BeforeSchoolGrantProgram = as.integer(any(!is.na(BeforeSchoolGrantProgram))),
    AfterSchoolGeneralFundedPrograms = as.integer(any(!is.na(AfterSchoolGeneralFundedPrograms))),
    btb_participation = ifelse(BeforeSchoolGrantProgram || AfterSchoolGeneralFundedPrograms, 1, 0)
  )

merged <- merged %>%
  left_join(btb_unique, by = "school_code")
names(merged)
```

``` {r, echo=FALSE}
# install.packages(c("rdrobust", "rddensity", "ggplot2"))
library(rdrobust)
library(rddensity)
library(ggplot2)

# If you just ran the script above you already have `merged`
data <- merged


```

```{r}
data


filtered_data <- data %>%
  filter(frpm_rate >= 0.7, frpm_rate <= 0.8, btb_participation == 1)

data %>%
  filter(frpm_rate > 0.75) %>%
  summarise(
    participated = sum(btb_participation == 1, na.rm = TRUE),
    not_participated = sum(btb_participation == 0, na.rm = TRUE),
    missing = sum(is.na(btb_participation))
  )

data %>%
  filter(frpm_rate <= 0.75, frpm_rate >= 0.7) %>%
  summarise(
    participated = sum(btb_participation == 1, na.rm = TRUE),
    not_participated = sum(btb_participation == 0, na.rm = TRUE),
    missing = sum(is.na(btb_participation))
  )

filtered_data
```

# II. Visualize the Discontinuity (RDD Plots)
What:
Plot outcome vs. FRPM %, and check for a visible jump at the cutoff.

Why it's important:
A visual RDD plot helps validate the first sign of a causal effect. It shows whether there's a discontinuity in outcomes at the eligibility threshold.

How it supports your thesis:
If you observe a clear jump in outcomes right at the cutoff, it’s strong preliminary evidence that the program has a measurable effect.

## Identification
2.2 Quick visual check

1. Overall Relationship
As FRPM eligibility increases, the general trend shows more variation in absenteeism rates, especially above 50%.

There's high heterogeneity: schools with similar FRPM rates can have widely different absenteeism rates. This is typical in education data.

2. The RDD Cutoff at 75%
The dashed line at 75% is the policy threshold: schools above it are considered “treated” (e.g., eligible for full program benefits).

Visually, you’re looking to see if there's a “jump” in the absenteeism rate right at that line.

3. Evidence of a Jump
Just right of the 75% line, there's a slight upward shift in absenteeism rates.

That suggests that being just above 75% FRPM might be associated with higher absenteeism, contrary to the expectation that programs like school food and afterschool support reduce absenteeism.
```{r}
library(rdrobust)
library(rddensity)

merged <- merged %>%
  mutate(
    frpm_rate = ifelse(frpm_rate <= 1, frpm_rate * 100, frpm_rate),
    running   = frpm_rate - 75,
    treated   = ifelse(frpm_rate >= 75, 1, 0)
  )

ggplot(merged, aes(frpm_rate, chronic_absenteeism)) +
  geom_point(alpha = .4) +
  geom_vline(xintercept = 75, linetype = "dashed") +
  labs(x = "FRPM eligibility rate (%)",
       y = "Chronic absenteeism rate (%)")

```

# Run the McCrary Density Test
What:
Run a McCrary test to check whether schools are manipulating FRPM % to just qualify for treatment (i.e., bunching right above the cutoff).

Why it's important:
RDD assumes that units cannot precisely manipulate the running variable. If schools are “gaming” the system, the design breaks down.

How it supports your thesis:
Passing the McCrary test strengthens your claim that the assignment to treatment is as-good-as-random near the threshold — key for making causal claims.

## 2.3 Test for manipulation of the running variable (McCrary test)
To assess whether the core assumption of quasi-random assignment around the 75% FRPM threshold holds, a McCrary density test was conducted. This diagnostic evaluates whether there is a discontinuity in the distribution of the running variable—school-level FRPM eligibility rates—at the treatment cutoff. The corresponding McCrary density plot (Figure X) visualizes the estimated densities on either side of the threshold, fitted separately using local polynomial smoothing. The results indicate that the density of schools is smooth across the 75% threshold, with no visible jump or drop and overlapping confidence intervals. This suggests that there is no systematic manipulation of FRPM rates by schools in order to qualify for program eligibility, thereby supporting the assumption that schools just above and just below the cutoff are comparable. The validity of this assumption is critical for interpreting the estimated treatment effect as causal, and the evidence from the McCrary test strengthens the credibility of the regression discontinuity design employed in this study.

```{r}
library(rddensity)

# 1. McCrary density test
dens75 <- rddensity(merged$frpm_rate, c = 75)
dens75$test            # prints t_jk and p_jk

# 2. Sharp RD estimate
rd75 <- rdrobust(merged$chronic_absenteeism,
                 merged$frpm_rate,
                 c          = 75,
                 masspoints = "adjust")
summary(rd75)

# 3. Density test statistics (use the right object)
dens75$test             # NOT rd75$test

# 4. McCrary density plot
# McCrary density test object
dens75 <- rddensity(merged$frpm_rate, c = 75)

# Density plot  ── rdd object first, X second ──
rdplotdensity(
  dens75,                 # ← rdd    (object returned by rddensity)
  merged$frpm_rate,       # ← X      (numeric running-variable vector)
  title  = "McCrary density plot at 75% FRPM",
  xlabel = "FRPM eligibility rate (%)",
  ylabel = "Estimated density"
)
```
Failing to reject H₀ (p > 0.05) means no evidence schools “bunch” just above the cutoff. 

2.4 Covariate Balance Checks
What: Test whether other school characteristics (like size, Title I status, ELL %, or student-teacher ratio) show any discontinuity at the 75% FRPM cutoff.
Why: Helps ensure schools are comparable across the threshold. No jump = stronger causal claim.
Where: Identification Strategy
```{r}
# install.packages("rdrobust")   # Only if not already installed
library(rdrobust)
names(merged)
covariates <- c("ChronicAbsenteeismEligibleCumulativeEnrollment")
                # "pct_english_learners", 
                # "pct_foster_youth", 
                # "pct_special_ed", 
                # "pct_homeless", 
                # "total_enrollment", 
                # "student_teacher_ratio"

for (var in covariates) {
  cat("▶︎ Covariate:", var, "\n")
  
  # Run rdrobust for covariate ~ frpm_rate
  result <- rdrobust(y = merged[[var]], x = merged$frpm_rate, c = 75)
  
  # Print coefficient and p-value
  print(summary(result))
}




```






# Run Robustness Checks
What:

Try different bandwidths

Use polynomial order sensitivity

Conduct placebo cutoffs (e.g., use 70% or 80% as fake cutoffs)

Check covariate balance across the cutoff

Why it's important:
Confirms your results are not artifacts of model specification or sample choice.

How it supports your thesis:
Robust findings across many conditions build a strong, credible argument for causal impact of the food or BTB programs.

2.5 Bandwidth Sensitivity
What: Try smaller and larger windows around the cutoff (e.g., ±3%, ±7%, ±10%).
Why: Tests if your results hold under different assumptions.
Where: Estimation Methods + Results

```{r}
# Load package
library(rdrobust)

# Declare models
m1  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 2, p = 1, masspoints = "adjust")
m2  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 2, p = 2, masspoints = "adjust")
m3  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 2, p = 3, masspoints = "adjust")
m4  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 3, p = 1, masspoints = "adjust")
m5  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 3, p = 2, masspoints = "adjust")
m6  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 3, p = 3, masspoints = "adjust")
m7  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 4, p = 1, masspoints = "adjust")
m8  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 4, p = 2, masspoints = "adjust")
m9  <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 4, p = 3, masspoints = "adjust")
m10 <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 5, p = 1, masspoints = "adjust")
m11 <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 5, p = 2, masspoints = "adjust")
m12 <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 5, p = 3, masspoints = "adjust")
m13 <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 6, p = 1, masspoints = "adjust")
m14 <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 6, p = 2, masspoints = "adjust")
m15 <- rdrobust(merged$chronic_absenteeism, merged$frpm_rate, c = 75, h = 6, p = 3, masspoints = "adjust")

# Store models with correct metadata manually
model_info <- data.frame(
  name = paste0("m", 1:15),
  cutoff = 75,
  bandwidth = rep(2:6, each = 3),
  poly_order = rep(1:3, times = 5),
  stringsAsFactors = FALSE
)

models <- list(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12, m13, m14, m15)

# Extract results and build table
robust_results <- do.call(rbind, Map(function(model, info) {
  data.frame(
    cutoff = info$cutoff,
    bandwidth = info$bandwidth,
    poly_order = info$poly_order,
    coef = model$coef[1, 1],
    se = model$se[1, 1],
    pval = model$pv[1, 1],
    ci_lower = model$ci[1, 1],
    ci_upper = model$ci[1, 2]
  )
}, models, split(model_info, seq(nrow(model_info)))))

# Show result
print(robust_results)


```




2.8 Graphical RDD Plot
What: Use rdplot() to show outcome vs. running variable with fit lines.
Why: Makes the discontinuity intuitive and visual.
Where: Results
```{r}
# Zoomed plots for top 6 models (focusing on 65% to 85% FRPM)

library(rdrobust)

# Local linear plots zoomed in (h = 3 to 6)
rdplot(merged$chronic_absenteeism, merged$frpm_rate,
       c = 75, h = 3, p = 1,
       x.lim = c(65, 85),
       title = "RDD Plot: h = 3, p = 1 (Local Linear)",
       x.label = "FRPM %", y.label = "Chronic Absenteeism")

rdplot(merged$chronic_absenteeism, merged$frpm_rate,
       c = 75, h = 4, p = 1,
       x.lim = c(65, 85),
       title = "RDD Plot: h = 4, p = 1 (Local Linear)",
       x.label = "FRPM %", y.label = "Chronic Absenteeism")

rdplot(merged$chronic_absenteeism, merged$frpm_rate,
       c = 75, h = 5, p = 1,
       x.lim = c(65, 85),
       title = "RDD Plot: h = 5, p = 1 (Local Linear)",
       x.label = "FRPM %", y.label = "Chronic Absenteeism")

rdplot(merged$chronic_absenteeism, merged$frpm_rate,
       c = 75, h = 6, p = 1,
       x.lim = c(68, 82),
       title = "RDD Plot: h = 6, p = 1 (Local Linear)",
       x.label = "FRPM %", y.label = "Chronic Absenteeism")

```