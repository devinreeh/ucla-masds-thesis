print(rdd_plot_avg_scale_score_ela_frpm_35)
rdd_avg_scale_score_ela_frpm_75 <- gp_rdd(df_clean$frpm_percent, df_clean$avg_scale_score_ELA, 75)
rdd_avg_scale_score_ela_frpm_75$tau
rdd_avg_scale_score_ela_frpm_75$se
rdd_avg_scale_score_ela_frpm_75$ci
rdd_plot_avg_scale_score_ela_frpm_75 <- gp_rdd_plot(rdd_avg_scale_score_ela_frpm_75) +
geom_vline(xintercept = 75, linetype = "dashed") +
coord_cartesian(xlim = c(50, 95)) +
labs(title = "Scale Score ELA ~ FRPM (75% Cutoff)")
print(rdd_plot_avg_scale_score_ela_frpm_75)
rdd_avg_scale_score_ela_undup_55 <- gp_rdd(df_clean$undup_pct, df_clean$avg_scale_score_ELA, 55)
rdd_avg_scale_score_ela_undup_55$tau
rdd_avg_scale_score_ela_undup_55$se
rdd_avg_scale_score_ela_undup_55$ci
rdd_plot_avg_scale_score_ela_undup_55 <- gp_rdd_plot(rdd_avg_scale_score_ela_undup_55) +
geom_vline(xintercept = 55, linetype = "dashed") +
coord_cartesian(xlim = c(30, 80)) +
labs(title = "Scale Score ELA ~ Undup (55% Cutoff)")
print(rdd_plot_avg_scale_score_ela_undup_55)
rdd_avg_scale_score_ela_undup_75 <- gp_rdd(df_clean$undup_pct, df_clean$avg_scale_score_ELA, 75)
rdd_avg_scale_score_ela_undup_75$tau
rdd_avg_scale_score_ela_undup_75$se
rdd_avg_scale_score_ela_undup_75$ci
rdd_plot_avg_scale_score_ela_undup_75 <- gp_rdd_plot(rdd_avg_scale_score_ela_undup_75) +
geom_vline(xintercept = 75, linetype = "dashed") +
coord_cartesian(xlim = c(50, 95)) +
labs(title = "Scale Score ELA ~ Undup (75% Cutoff)")
print(rdd_plot_avg_scale_score_ela_undup_75)
# ──────────────────────────────────────────────────────────────
# Balance Tests with GP-RDD for Two Running Variables (FRPM and UPP)
# ──────────────────────────────────────────────────────────────
library(dplyr)
library(tidyr)
library(gpss)
# -----------------------------
# Continuous Covariates Balance via GP-RDD
# -----------------------------
gp_rdd_balance_test_cont <- function(df, var, running_var, cutoff) {
df_sub <- df %>% filter(!is.na(.data[[var]]), !is.na(.data[[running_var]]))
rdd_result <- gp_rdd(df_sub[[running_var]], df_sub[[var]], cutoff)
tibble(
variable = var,
running_var = running_var,
cutoff = cutoff,
tau = rdd_result$tau,
se = rdd_result$se,
p_value = 2 * pnorm(-abs(rdd_result$tau / rdd_result$se)),
ci_lower = rdd_result$ci[1],
ci_upper = rdd_result$ci[2]
)
}
# -----------------------------
# Binary Categorical Covariates Balance via GP-RDD
# -----------------------------
gp_rdd_balance_test_binary <- function(df, var, running_var, cutoff) {
df_sub <- df %>% filter(!is.na(.data[[var]]), !is.na(.data[[running_var]]))
df_sub <- df_sub %>% mutate(dummy = as.numeric(trimws(.data[[var]]) == "Yes" | .data[[var]] == 1))
rdd_result <- gp_rdd(df_sub[[running_var]], df_sub$dummy, cutoff)
tibble(
variable = var,
running_var = running_var,
cutoff = cutoff,
tau = rdd_result$tau,
se = rdd_result$se,
p_value = 2 * pnorm(-abs(rdd_result$tau / rdd_result$se)),
ci_lower = rdd_result$ci[1],
ci_upper = rdd_result$ci[2]
)
}
# -----------------------------
# Run All Balance Tests
# -----------------------------
continuous_covariates <- c("pct_hispanic", "pct_black", "pct_white", "pct_asian",
"pct_two_or_more", "pct_other", "total_enroll")
categorical_covariates <- c("Charter.School", "DASS")
cutoffs <- list(
list(running = "frpm_rate", value = 0.35),
list(running = "frpm_rate", value = 0.75),
list(running = "undup_pct", value = 55),
list(running = "undup_pct", value = 75)
)
balance_all <- purrr::map_dfr(cutoffs, function(cut) {
cont_results <- purrr::map_dfr(continuous_covariates, ~gp_rdd_balance_test_cont(df_clean, .x, cut$running, cut$value))
cat_results  <- purrr::map_dfr(categorical_covariates, ~gp_rdd_balance_test_binary(df_clean, .x, cut$running, cut$value))
bind_rows(cont_results, cat_results)
})
# -----------------------------
# Print results
# -----------------------------
print(balance_all)
# Function to run GP-RDD balance test using UPP as the running variable
gp_rdd_balance_test_upp <- function(df, var, cutoff = 55) {
df_sub <- df %>% filter(!is.na(.data[[var]]), !is.na(undup_pct))
rdd_result <- gp_rdd(df_sub$undup_pct, df_sub[[var]], cutoff)
tibble(
variable = var,
tau = rdd_result$tau,
se = rdd_result$se,
p_value = 2 * pnorm(-abs(rdd_result$tau / rdd_result$se)),
ci_lower = rdd_result$ci[1],
ci_upper = rdd_result$ci[2]
)
}
# List of covariates to test for balance
covariates <- c(
"pct_hispanic", "pct_black", "pct_white", "pct_asian",
"pct_two_or_more", "pct_other"
)
# Run tests around UPP = 55%
balance_upp_55 <- lapply(covariates, gp_rdd_balance_test_upp, df = df_clean, cutoff = 55) %>%
bind_rows()
# Run tests around UPP = 75%
balance_upp_75 <- lapply(covariates, gp_rdd_balance_test_upp, df = df_clean, cutoff = 75) %>%
bind_rows()
# Display results
print("GP-RDD Balance Tests around UPP 55% cutoff")
print(balance_upp_55)
print("GP-RDD Balance Tests around UPP 75% cutoff")
print(balance_upp_75)
# GP-RDD with covariate adjustment (demographic variables that showed imbalance)
model_y_adj <- gpss(
formula = chronic_absenteeism ~ treated + running +
Charter.School + DASS +
pct_hispanic + pct_white + pct_two_or_more,
data = df_clean
)
# Summary output
summary(model_y_adj)
rdd_avg_scale_score_math_frpm_35 <- gp_rdd(df_clean$frpm_percent, df_clean$avg_scale_score_Math, 35)
rdd_avg_scale_score_math_frpm_35$tau
rdd_avg_scale_score_math_frpm_35$se
rdd_avg_scale_score_math_frpm_35$ci
rdd_plot_avg_scale_score_math_frpm_35 <- gp_rdd_plot(rdd_avg_scale_score_math_frpm_35) +
geom_vline(xintercept = 35, linetype = "dashed") +
coord_cartesian(xlim = c(20, 60)) +
labs(title = "Scale Score Math ~ FRPM (35% Cutoff)")
print(rdd_plot_avg_scale_score_math_frpm_35)
rdd_avg_scale_score_math_frpm_75 <- gp_rdd(df_clean$frpm_percent, df_clean$avg_scale_score_Math, 75)
rdd_avg_scale_score_math_frpm_75$tau
rdd_avg_scale_score_math_frpm_75$se
rdd_avg_scale_score_math_frpm_75$ci
rdd_plot_avg_scale_score_math_frpm_75 <- gp_rdd_plot(rdd_avg_scale_score_math_frpm_75) +
geom_vline(xintercept = 75, linetype = "dashed") +
coord_cartesian(xlim = c(50, 95)) +
labs(title = "Scale Score Math ~ FRPM (75% Cutoff)")
print(rdd_plot_avg_scale_score_math_frpm_75)
rdd_avg_scale_score_math_undup_55 <- gp_rdd(df_clean$undup_pct, df_clean$avg_scale_score_Math, 55)
rdd_avg_scale_score_math_undup_55$tau
rdd_avg_scale_score_math_undup_55$se
rdd_avg_scale_score_math_undup_55$ci
rdd_plot_avg_scale_score_math_undup_55 <- gp_rdd_plot(rdd_avg_scale_score_math_undup_55) +
geom_vline(xintercept = 55, linetype = "dashed") +
coord_cartesian(xlim = c(30, 80)) +
labs(title = "Scale Score Math ~ Undup (55% Cutoff)")
print(rdd_plot_avg_scale_score_math_undup_55)
rdd_avg_scale_score_math_undup_75 <- gp_rdd(df_clean$undup_pct, df_clean$avg_scale_score_Math, 75)
rdd_avg_scale_score_math_undup_75$tau
rdd_avg_scale_score_math_undup_75$se
rdd_avg_scale_score_math_undup_75$ci
rdd_plot_avg_scale_score_math_undup_75 <- gp_rdd_plot(rdd_avg_scale_score_math_undup_75) +
geom_vline(xintercept = 75, linetype = "dashed") +
coord_cartesian(xlim = c(50, 95)) +
labs(title = "Scale Score Math ~ Undup (75% Cutoff)")
print(rdd_plot_avg_scale_score_math_undup_75)
# ──────────────────────────────────────────────────────────────
# Balance Tests with GP-RDD for Two Running Variables (FRPM and UPP)
# ──────────────────────────────────────────────────────────────
library(dplyr)
library(tidyr)
library(gpss)
# -----------------------------
# Continuous Covariates Balance via GP-RDD
# -----------------------------
gp_rdd_balance_test_cont <- function(df, var, running_var, cutoff) {
df_sub <- df %>% filter(!is.na(.data[[var]]), !is.na(.data[[running_var]]))
rdd_result <- gp_rdd(df_sub[[running_var]], df_sub[[var]], cutoff)
tibble(
variable = var,
running_var = running_var,
cutoff = cutoff,
tau = rdd_result$tau,
se = rdd_result$se,
p_value = 2 * pnorm(-abs(rdd_result$tau / rdd_result$se)),
ci_lower = rdd_result$ci[1],
ci_upper = rdd_result$ci[2]
)
}
# -----------------------------
# Binary Categorical Covariates Balance via GP-RDD
# -----------------------------
gp_rdd_balance_test_binary <- function(df, var, running_var, cutoff) {
df_sub <- df %>% filter(!is.na(.data[[var]]), !is.na(.data[[running_var]]))
df_sub <- df_sub %>% mutate(dummy = as.numeric(trimws(.data[[var]]) == "Yes" | .data[[var]] == 1))
rdd_result <- gp_rdd(df_sub[[running_var]], df_sub$dummy, cutoff)
tibble(
variable = var,
running_var = running_var,
cutoff = cutoff,
tau = rdd_result$tau,
se = rdd_result$se,
p_value = 2 * pnorm(-abs(rdd_result$tau / rdd_result$se)),
ci_lower = rdd_result$ci[1],
ci_upper = rdd_result$ci[2]
)
}
# -----------------------------
# Run All Balance Tests
# -----------------------------
continuous_covariates <- c("pct_hispanic", "pct_black", "pct_white", "pct_asian",
"pct_two_or_more", "pct_other", "total_enroll")
categorical_covariates <- c("Charter.School", "DASS")
cutoffs <- list(
list(running = "frpm_rate", value = 0.35),
list(running = "frpm_rate", value = 0.75),
list(running = "undup_pct", value = 55),
list(running = "undup_pct", value = 75)
)
balance_all <- purrr::map_dfr(cutoffs, function(cut) {
cont_results <- purrr::map_dfr(continuous_covariates, ~gp_rdd_balance_test_cont(df_clean, .x, cut$running, cut$value))
cat_results  <- purrr::map_dfr(categorical_covariates, ~gp_rdd_balance_test_binary(df_clean, .x, cut$running, cut$value))
bind_rows(cont_results, cat_results)
})
# -----------------------------
# Print results
# -----------------------------
print(balance_all)
# Function to run GP-RDD balance test using UPP as the running variable
gp_rdd_balance_test_upp <- function(df, var, cutoff = 55) {
df_sub <- df %>% filter(!is.na(.data[[var]]), !is.na(undup_pct))
rdd_result <- gp_rdd(df_sub$undup_pct, df_sub[[var]], cutoff)
tibble(
variable = var,
tau = rdd_result$tau,
se = rdd_result$se,
p_value = 2 * pnorm(-abs(rdd_result$tau / rdd_result$se)),
ci_lower = rdd_result$ci[1],
ci_upper = rdd_result$ci[2]
)
}
# List of covariates to test for balance
covariates <- c(
"pct_hispanic", "pct_black", "pct_white", "pct_asian",
"pct_two_or_more", "pct_other"
)
# Run tests around UPP = 55%
balance_upp_55 <- lapply(covariates, gp_rdd_balance_test_upp, df = df_clean, cutoff = 55) %>%
bind_rows()
# Run tests around UPP = 75%
balance_upp_75 <- lapply(covariates, gp_rdd_balance_test_upp, df = df_clean, cutoff = 75) %>%
bind_rows()
# Display results
print("GP-RDD Balance Tests around UPP 55% cutoff")
print(balance_upp_55)
print("GP-RDD Balance Tests around UPP 75% cutoff")
print(balance_upp_75)
# GP-RDD with covariate adjustment (demographic variables that showed imbalance)
model_y_adj <- gpss(
formula = chronic_absenteeism ~ treated + running +
Charter.School + DASS +
pct_hispanic + pct_white + pct_two_or_more,
data = df_clean
)
# Summary output
summary(model_y_adj)
# Utility function to extract results from a gp_rdd object
extract_rdd_result <- function(obj, label) {
tibble(
model = label,
tau = obj$tau,
se = obj$se,
ci_lower = obj$ci[1],
ci_upper = obj$ci[2],
p_value = 2 * pnorm(-abs(obj$tau / obj$se)),
significant = ifelse(p_value < 0.05, TRUE, FALSE)
)
}
# Combine all results into one table
rdd_summary_table <- bind_rows(
extract_rdd_result(rdd_avg_pct_not_met_math_frpm_35, "% Not Met Math ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_frpm_75, "% Not Met Math ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_undup_55, "% Not Met Math ~ Undup (55%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_undup_75, "% Not Met Math ~ Undup (75%)"),
extract_rdd_result(rdd_avg_scale_score_ela_frpm_35, "Scale ELA ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_scale_score_ela_frpm_75, "Scale ELA ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_scale_score_ela_undup_55, "Scale ELA ~ Undup (55%)"),
extract_rdd_result(rdd_avg_scale_score_ela_undup_75, "Scale ELA ~ Undup (75%)"),
extract_rdd_result(rdd_avg_scale_score_math_frpm_35, "Scale Math ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_scale_score_math_frpm_75, "Scale Math ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_scale_score_math_undup_55, "Scale Math ~ Undup (55%)"),
extract_rdd_result(rdd_avg_scale_score_math_undup_75, "Scale Math ~ Undup (75%)")
)
print(rdd_summary_table)
# Utility function to extract results from a gp_rdd object
extract_rdd_result <- function(obj, label) {
tibble(
model = label,
tau = obj$tau,
se = obj$se,
ci_lower = obj$ci[1],
ci_upper = obj$ci[2],
p_value = 2 * pnorm(-abs(obj$tau / obj$se)),
significant = ifelse(p_value < 0.05, TRUE, FALSE)
)
}
# Combine all results into one table
rdd_summary_table <- bind_rows(
extract_rdd_result(rdd_avg_pct_met_above_ela_frpm_35, "% MetAbove ELA ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_pct_met_above_ela_frpm_75, "% MetAbove ELA ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_pct_met_above_ela_undup_55, "% MetAbove ELA ~ Undup (55%)"),
extract_rdd_result(rdd_avg_pct_met_above_ela_undup_75, "% MetAbove ELA ~ Undup (75%)"),
extract_rdd_result(rdd_avg_pct_met_above_math_frpm_35, "% MetAbove Math ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_pct_met_above_math_frpm_75, "% MetAbove Math ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_pct_met_above_math_undup_55, "% MetAbove Math ~ Undup (55%)"),
extract_rdd_result(rdd_avg_pct_met_above_math_undup_75, "% MetAbove Math ~ Undup (75%)"),
extract_rdd_result(rdd_res_absenteeism_frpm_35_cutoff, "Chronic Absenteeism ~ FRPM (35%)"),
extract_rdd_result(rdd_res_absenteeism_frpm_75_cutoff, "Chronic Absenteeism ~ FRPM (75%)"),
extract_rdd_result(rdd_res_absenteeism_BTB_35_cutoff, "BTB ~ FRPM (35%)"),
extract_rdd_result(rdd_res_absenteeism_BTB_75_cutoff, "BTB ~ FRPM (75%)"),
extract_rdd_result(rdd_res_absenteeism_undup_55_cutoff, "Chronic Absenteeism ~ Undup (55%)"),
extract_rdd_result(rdd_res_absenteeism_undup_75_cutoff, "Chronic Absenteeism ~ Undup (75%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_frpm_35, "% Not Met Math ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_frpm_75, "% Not Met Math ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_undup_55, "% Not Met Math ~ Undup (55%)"),
extract_rdd_result(rdd_avg_pct_not_met_math_undup_75, "% Not Met Math ~ Undup (75%)"),
extract_rdd_result(rdd_avg_scale_score_ela_frpm_35, "Scale ELA ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_scale_score_ela_frpm_75, "Scale ELA ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_scale_score_ela_undup_55, "Scale ELA ~ Undup (55%)"),
extract_rdd_result(rdd_avg_scale_score_ela_undup_75, "Scale ELA ~ Undup (75%)"),
extract_rdd_result(rdd_avg_scale_score_math_frpm_35, "Scale Math ~ FRPM (35%)"),
extract_rdd_result(rdd_avg_scale_score_math_frpm_75, "Scale Math ~ FRPM (75%)"),
extract_rdd_result(rdd_avg_scale_score_math_undup_55, "Scale Math ~ Undup (55%)"),
extract_rdd_result(rdd_avg_scale_score_math_undup_75, "Scale Math ~ Undup (75%)")
)
print(rdd_summary_table)
run_adjusted_rdd <- function(yvar, running_var, cutoff, covariates, df) {
df <- df %>%
mutate(
treated = ifelse(.data[[running_var]] >= cutoff, 1, 0),
running = .data[[running_var]] - cutoff
)
fml <- as.formula(paste0(yvar, " ~ treated + running + ", paste(covariates, collapse = " + ")))
model <- gpss::gpss(formula = fml, data = df)
est <- summary(model)
tibble(
model = paste0(yvar, " ~ ", running_var, " (", cutoff, "% adj)"),
tau = est$coefficients["treated", "Estimate"],
se = est$coefficients["treated", "Std. Error"],
ci_lower = est$coefficients["treated", "Estimate"] - 1.96 * est$coefficients["treated", "Std. Error"],
ci_upper = est$coefficients["treated", "Estimate"] + 1.96 * est$coefficients["treated", "Std. Error"],
p_value = est$coefficients["treated", "Pr(>|t|)"],
significant = est$coefficients["treated", "Pr(>|t|)"] < 0.05
)
}
covariates_to_adjust <- c("Charter.School", "DASS", "pct_hispanic", "pct_white", "pct_asian", "pct_two_or_more")
adjusted_results <- bind_rows(
run_adjusted_rdd("avg_pct_met_above_ELA", "frpm_percent", 35, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_pct_met_above_Math", "frpm_percent", 35, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_pct_not_met_Math", "frpm_percent", 35, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_scale_score_ELA", "frpm_percent", 35, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_scale_score_Math", "frpm_percent", 35, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_pct_met_above_ELA", "undup_pct", 55, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_pct_met_above_Math", "undup_pct", 55, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_pct_not_met_Math", "undup_pct", 55, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_scale_score_ELA", "undup_pct", 55, covariates_to_adjust, df_clean),
run_adjusted_rdd("avg_scale_score_Math", "undup_pct", 55, covariates_to_adjust, df_clean)
)
full_rdd_summary_table <- bind_rows(rdd_summary_table, adjusted_results)
# ──────────────────────────────────────────────────────────────
# Covariate-Adjusted GP-RDD Models (FRPM = 35%, Undup = 55%)
# ──────────────────────────────────────────────────────────────
# Helper function to run adjusted GP-RDD model
run_adjusted_rdd <- function(outcome_var, running_var, cutoff, covariates, data) {
formula_str <- paste0(
outcome_var, " ~ I(", running_var, " >= ", cutoff, ") + ",
running_var, " + ",
paste(covariates, collapse = " + ")
)
model <- gpss(
formula = as.formula(formula_str),
data = data
)
est <- summary(model)$coefficients
tau_row <- est[grepl(paste0("I\\(", running_var, " >= ", cutoff, "\\)"), rownames(est)), ]
tibble(
model = paste(outcome_var, "~", running_var, "adj @", cutoff),
tau = tau_row["Estimate"],
se = tau_row["Std. Error"],
ci_lower = tau_row["Estimate"] - 1.96 * tau_row["Std. Error"],
ci_upper = tau_row["Estimate"] + 1.96 * tau_row["Std. Error"],
p_value = 2 * pnorm(-abs(tau_row["Estimate"] / tau_row["Std. Error"])),
significant = p_value < 0.05
)
}
# Variables and cutoffs to adjust for
outcomes <- c(
"avg_pct_met_above_ELA",
"avg_pct_met_above_Math",
"avg_pct_not_met_ELA",
"avg_pct_not_met_Math",
"avg_scale_score_ELA",
"avg_scale_score_Math",
"chronic_absenteeism",
"btb"
)
covariates_to_adjust <- c("Charter.School", "DASS", "pct_hispanic", "pct_white", "pct_two_or_more")
# Generate adjusted model results
adjusted_results <- bind_rows(
# FRPM = 35%
purrr::map_dfr(outcomes, ~run_adjusted_rdd(.x, "frpm_percent", 35, covariates_to_adjust, df_clean)),
# Undup = 55%
purrr::map_dfr(outcomes, ~run_adjusted_rdd(.x, "undup_pct", 55, covariates_to_adjust, df_clean))
)
# Append to existing unadjusted summary table
full_rdd_summary_table <- bind_rows(
rdd_summary_table,
adjusted_results
)
# Display full table
knitr::kable(full_rdd_summary_table, caption = "Summary of All GP-RDD Models (Unadjusted and Covariate-Adjusted)")
print(full_rdd_summary_table)
print(comparison_table)
rdd_summary_table <- rdd_summary_table %>%
mutate(model_type = "Unadjusted")
rdd_summary_table_adj <- rdd_summary_table_adj %>%
mutate(model_type = "Adjusted")
# Combine into long format
combined_long <- bind_rows(rdd_summary_table, rdd_summary_table_adj)
# Reshape into wide format for comparison
comparison_table <- combined_long %>%
select(model, model_type, tau, se, p_value, significant) %>%
pivot_wider(
names_from = model_type,
values_from = c(tau, se, p_value, significant),
names_glue = "{.value}_{model_type}"
) %>%
mutate(
tau_diff = tau_Adjusted - tau_Unadjusted,
se_diff = se_Adjusted - se_Unadjusted,
signif_change = significant_Unadjusted != significant_Adjusted
)
print(comparison_table)
# ──────────────────────────────────────────────────────────────
# Covariate-Adjusted GP-RDD Models (FRPM = 35%, Undup = 55%)
# ──────────────────────────────────────────────────────────────
# Helper function to run adjusted GP-RDD model
run_adjusted_rdd <- function(outcome_var, running_var, cutoff, covariates, data) {
formula_str <- paste0(
outcome_var, " ~ I(", running_var, " >= ", cutoff, ") + ",
running_var, " + ",
paste(covariates, collapse = " + ")
)
model <- gpss(
formula = as.formula(formula_str),
data = data
)
est <- summary(model)$coefficients
tau_row <- est[grepl(paste0("I\\(", running_var, " >= ", cutoff, "\\)"), rownames(est)), ]
tibble(
model = paste(outcome_var, "~", running_var, "adj @", cutoff),
tau = tau_row["Estimate"],
se = tau_row["Std. Error"],
ci_lower = tau_row["Estimate"] - 1.96 * tau_row["Std. Error"],
ci_upper = tau_row["Estimate"] + 1.96 * tau_row["Std. Error"],
p_value = 2 * pnorm(-abs(tau_row["Estimate"] / tau_row["Std. Error"])),
significant = p_value < 0.05
)
}
# Variables and cutoffs to adjust for
outcomes <- c(
"avg_pct_met_above_ELA",
"avg_pct_met_above_Math",
"avg_pct_not_met_ELA",
"avg_pct_not_met_Math",
"avg_scale_score_ELA",
"avg_scale_score_Math",
"chronic_absenteeism",
"btb"
)
covariates_to_adjust <- c("Charter.School", "DASS", "pct_hispanic", "pct_white", "pct_two_or_more")
# Generate adjusted model results
adjusted_results <- bind_rows(
# FRPM = 35%
purrr::map_dfr(outcomes, ~run_adjusted_rdd(.x, "frpm_percent", 35, covariates_to_adjust, df_clean)),
# Undup = 55%
purrr::map_dfr(outcomes, ~run_adjusted_rdd(.x, "undup_pct", 55, covariates_to_adjust, df_clean))
)
# Append to existing unadjusted summary table
rdd_summary_table_adj <- bind_rows(
rdd_summary_table,
adjusted_results
)
print(rdd_summary_table_adj)
rdd_summary_table <- rdd_summary_table %>%
mutate(model_type = "Unadjusted")
rdd_summary_table_adj <- rdd_summary_table_adj %>%
mutate(model_type = "Adjusted")
# Combine into long format
combined_long <- bind_rows(rdd_summary_table, rdd_summary_table_adj)
# Reshape into wide format for comparison
comparison_table <- combined_long %>%
select(model, model_type, tau, se, p_value, significant) %>%
pivot_wider(
names_from = model_type,
values_from = c(tau, se, p_value, significant),
names_glue = "{.value}_{model_type}"
) %>%
mutate(
tau_diff = tau_Adjusted - tau_Unadjusted,
se_diff = se_Adjusted - se_Unadjusted,
signif_change = significant_Unadjusted != significant_Adjusted
)
print(comparison_table)
